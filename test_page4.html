<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>심리 테스트 - 설문 페이지 4 (SVG 버튼 적용)</title>
    <style>
        
        /* SUIT 폰트 정의 (경로 유지) */
        @font-face {
            font-family: 'SUIT';
            src: url('Font/SUIT-Light.ttf') format('truetype');
            font-weight: 300; 
            font-style: normal;
        }
        @font-face {
            font-family: 'SUIT';
            src: url('Font/SUIT-Regular.ttf') format('truetype');
            font-weight: 400; 
            font-style: normal;
        }
        @font-face {
            font-family: 'SUIT';
            src: url('Font/SUIT-Medium.ttf') format('truetype'); 
            font-weight: 500;
            font-style: normal;
        }
        @font-face {
            font-family: 'SUIT';
            src: url('Font/SUIT-Bold.ttf') format('truetype');
            font-weight: 700;
            font-style: normal;
        }
        @font-face {
            font-family: 'SUIT';
            src: url('Font/SUIT-ExtraBold.ttf') format('truetype');
            font-weight: 800; 
            font-style: normal;
        }


        :root {
            --main-text-color: #161317;
            --sub-text-color: #535353;
            --line-color: #ced4da;
            --topbar-height-vw: 27.2vw; 
            --bottombar-height-vw: 21.33vw; 
            --circle-size: 16vw; /* 60px */ 
            --font-suit: 'SUIT', -apple-system, 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            --selected-color: #007bff; 
        }

        body {
            width: 100vw; 
            min-height: 100vh;
            margin: 0;
            padding: 0;
            background-color: #FDFDFD; 
            overflow-x: hidden; 
            font-family: var(--font-suit);
            box-sizing: border-box;
            display: flex; 
            justify-content: center;
        }

        .screen-container {
            width: 100%;
            max-width: 375px; 
            min-height: 100vh;
            position: relative;
            background-color: #FDFDFD;
        }

        .main-content {
            /* 336px 너비를 위해 패딩 조정: 375 - 336 = 39. 39/2 = 19.5px. 19.5px / 3.75 = 5.2vw */
            width: 100%;
            padding: 0 5.2vw; /* 19.5px */
            box-sizing: border-box;
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch; 
        }
        
        .scroll-content-wrapper { 
            width: 100%; 
            padding-top: 8vw; 
            padding-bottom: 5.33vw; 
            position: relative; 
        }
        
        .main-content::-webkit-scrollbar { display: none; }
        .main-content { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* ------------------------- 설문 요소 스타일 (VW로 변환) ------------------------- */
        
        .question-number { 
            font-family: var(--font-suit); 
            font-size: 4.8vw; 
            font-weight: 800; 
            color: #9A9A9A; 
            margin-top: -1.33vw; 
            margin-bottom: 2.67vw; 
        }
        
        .survey-question { 
            font-family: var(--font-suit); 
            font-size: 4vw; /* 15px */
            font-weight: 700; /* Bold */
            letter-spacing: -0.07vw; /* -0.3px */
            color: var(--main-text-color); 
            line-height: 1.4; 
            margin-bottom: 2.67vw; 
            width: 100%; 
        }
        
        /* .survey-question-block의 width: 100%는 .main-content의 5.2vw 패딩 덕분에 336px이 됨 */
        .survey-question-block { width: 100%; margin-bottom: 5.33vw; padding: 5.33vw; border: 0.5px solid var(--line-color); border-radius: 2.13vw; background-color: #FFFFFF; box-sizing: border-box; box-shadow: 0 0.267vw 0.8vw rgba(0,0,0,0.05); }
        .options-area-wrapper { position: relative; height: var(--circle-size); width: 100%; display: flex; justify-content: space-between; padding: 0; box-sizing: border-box; margin-bottom: 4vw; }
        
        .options-item { 
            position: relative; 
            width: var(--circle-size); 
            height: var(--circle-size); 
            cursor: pointer; 
        }
        
        .options-item img {
            width: 100%;
            height: 100%;
            display: block;
            object-fit: contain;
            z-index: 1; 
        }
        
        .options-description { 
            width: 100%; 
            display: flex; 
            justify-content: space-between; 
            padding: 0; 
            box-sizing: border-box; 
            margin-top: 1.33vw; 
        }
        
        .options-description span {
            font-family: var(--font-suit); 
            font-size: 2.67vw; 
            font-weight: 300; 
            color: var(--sub-text-color);
            width: var(--circle-size); 
            text-align: center; 
            padding: 0;
        }

        .submit-button-container { width: 100%; display: flex; justify-content: center; margin-top: 8vw; padding-bottom: 5.33vw; }
        
        .submit-button { 
            width: 90%; 
            height: 13.33vw; 
            background-color: var(--main-text-color); 
            border: none; 
            border-radius: 2.13vw; 
            font-family: var(--font-suit); 
            font-size: 4.27vw; 
            font-weight: 800; 
            color: #FFFFFF; 
            cursor: pointer; 
            text-align: center; 
        }

        .top-quiz-header {
            width: 100%;
            display: flex;
            align-items: center;
            position: relative;
            padding-top: 2.67vw;
            padding-bottom: 8vw;
        }

        .nav-icon {
            position: absolute;
            left: 0;
            z-index: 5;
            font-family: var(--font-suit);
            font-size: 6.4vw; /* 24px */
            font-weight: 300;
            color: var(--main-text-color);
            line-height: 1;
            cursor: pointer;
        }

        .page-indicator {
            flex-grow: 1;
            text-align: center;
            font-family: var(--font-suit);
            font-size: 3.73vw; /* 14px */
            font-weight: 400;
            color: var(--main-text-color);
            line-height: 1;
        }
    </style>
</head>
<body>
    <div class="screen-container">
        <div class="main-content">
            <div class="scroll-content-wrapper">
                
                <div class="top-quiz-header">
                    <div class="nav-icon">&lt;</div>
                    <div class="page-indicator">4 / 4</div>
                </div>

                <div class="survey-question-block" data-question-id="Q25">
                    <div class="question-number">Q25.</div>
                    <div class="survey-question">혼자서 무언가를 할 때 더 쉽게 집중할 수 있으며, 방해 없이 몰두하는 것을 선호하나요?</div>
                    <div class="options-area-wrapper">
                        <div class="options-item" data-value="0"><img src="Image/기본버튼0.svg" alt="옵션 0 버튼"></div>
                        <div class="options-item" data-value="1"><img src="Image/기본버튼1.svg" alt="옵션 1 버튼"></div>
                        <div class="options-item" data-value="2"><img src="Image/기본버튼2.svg" alt="옵션 2 버튼"></div>
                        <div class="options-item" data-value="3"><img src="Image/기본버튼3.svg" alt="옵션 3 버튼"></div>
                    </div>
                    <div class="options-description">
                        <span>전혀 아니다</span>
                        <span>매우 그렇다</span>
                    </div>
                </div>

                <div class="survey-question-block" data-question-id="Q26">
                    <div class="question-number">Q26.</div>
                    <div class="survey-question">다른 사람들이 나를 이상하게 보거나 무시하고 있다고 느낀 적이 있나요?</div>
                    <div class="options-area-wrapper">
                        <div class="options-item" data-value="0"><img src="Image/기본버튼0.svg" alt="옵션 0 버튼"></div>
                        <div class="options-item" data-value="1"><img src="Image/기본버튼1.svg" alt="옵션 1 버튼"></div>
                        <div class="options-item" data-value="2"><img src="Image/기본버튼2.svg" alt="옵션 2 버튼"></div>
                        <div class="options-item" data-value="3"><img src="Image/기본버튼3.svg" alt="옵션 3 버튼"></div>
                    </div>
                    <div class="options-description">
                        <span>전혀 아니다</span>
                        <span>매우 그렇다</span>
                    </div>
                </div>

                <div class="survey-question-block" data-question-id="Q27">
                    <div class="question-number">Q27.</div>
                    <div class="survey-question">상황을 통제하기 어려운 순간에도 흔들리지 않고 냉정을 유지하며 침착하게 대처하는 편인가요?</div>
                    <div class="options-area-wrapper">
                        <div class="options-item" data-value="0"><img src="Image/기본버튼0.svg" alt="옵션 0 버튼"></div>
                        <div class="options-item" data-value="1"><img src="Image/기본버튼1.svg" alt="옵션 1 버튼"></div>
                        <div class="options-item" data-value="2"><img src="Image/기본버튼2.svg" alt="옵션 2 버튼"></div>
                        <div class="options-item" data-value="3"><img src="Image/기본버튼3.svg" alt="옵션 3 버튼"></div>
                    </div>
                    <div class="options-description">
                        <span>전혀 아니다</span>
                        <span>매우 그렇다</span>
                    </div>
                </div>

                <div class="survey-question-block" data-question-id="Q28">
                    <div class="question-number">Q28.</div>
                    <div class="survey-question">최근 2주 동안, 내가 원하는 것을 얻지 못해서 좌절감을 느끼거나 실망감을 말했던 적이 얼마나 자주 있나요?</div>
                    <div class="options-area-wrapper">
                        <div class="options-item" data-value="0"><img src="Image/기본버튼0.svg" alt="옵션 0 버튼"></div>
                        <div class="options-item" data-value="1"><img src="Image/기본버튼1.svg" alt="옵션 1 버튼"></div>
                        <div class="options-item" data-value="2"><img src="Image/기본버튼2.svg" alt="옵션 2 버튼"></div>
                        <div class="options-item" data-value="3"><img src="Image/기본버튼3.svg" alt="옵션 3 버튼"></div>
                    </div>
                    <div class="options-description">
                        <span>전혀 아니다</span>
                        <span>매우 그렇다</span>
                    </div>
                </div>

                <div class="survey-question-block" data-question-id="Q29">
                    <div class="question-number">Q29.</div>
                    <div class="survey-question">인터넷이나 스마트폰을 사용해야 한다는 생각 때문에 수면 시간을 줄인 적이 있나요?</div>
                    <div class="options-area-wrapper">
                        <div class="options-item" data-value="0"><img src="Image/기본버튼0.svg" alt="옵션 0 버튼"></div>
                        <div class="options-item" data-value="1"><img src="Image/기본버튼1.svg" alt="옵션 1 버튼"></div>
                        <div class="options-item" data-value="2"><img src="Image/기본버튼2.svg" alt="옵션 2 버튼"></div>
                        <div class="options-item" data-value="3"><img src="Image/기본버튼3.svg" alt="옵션 3 버튼"></div>
                    </div>
                    <div class="options-description">
                        <span>전혀 아니다</span>
                        <span>매우 그렇다</span>
                    </div>
                </div>

                <div class="survey-question-block" data-question-id="Q30">
                    <div class="question-number">Q30.</div>
                    <div class="survey-question">최근 2주 동안, 식욕이 없거나 너무 많이 먹어서 괴로웠던 적이 얼마나 자주 있나요?</div>
                    <div class="options-area-wrapper">
                        <div class="options-item" data-value="0"><img src="Image/기본버튼0.svg" alt="옵션 0 버튼"></div>
                        <div class="options-item" data-value="1"><img src="Image/기본버튼1.svg" alt="옵션 1 버튼"></div>
                        <div class="options-item" data-value="2"><img src="Image/기본버튼2.svg" alt="옵션 2 버튼"></div>
                        <div class="options-item" data-value="3"><img src="Image/기본버튼3.svg" alt="옵션 3 버튼"></div>
                    </div>
                    <div class="options-description">
                        <span>전혀 아니다</span>
                        <span>매우 그렇다</span>
                    </div>
                </div>

                <div class="survey-question-block" data-question-id="Q31">
                    <div class="question-number">Q31.</div>
                    <div class="survey-question">새로운 사람들을 만나는 자리나 모임에서 대화의 주도권을 잡고 분위기를 이끌어가는 편인가요?</div>
                    <div class="options-area-wrapper">
                        <div class="options-item" data-value="0"><img src="Image/기본버튼0.svg" alt="옵션 0 버튼"></div>
                        <div class="options-item" data-value="1"><img src="Image/기본버튼1.svg" alt="옵션 1 버튼"></div>
                        <div class="options-item" data-value="2"><img src="Image/기본버튼2.svg" alt="옵션 2 버튼"></div>
                        <div class="options-item" data-value="3"><img src="Image/기본버튼3.svg" alt="옵션 3 버튼"></div>
                    </div>
                    <div class="options-description">
                        <span>전혀 아니다</span>
                        <span>매우 그렇다</span>
                    </div>
                </div>

                <div class="survey-question-block" data-question-id="Q32">
                    <div class="question-number">Q32.</div>
                    <div class="survey-question">나를 비판하거나 부정적으로 말하는 사람들의 의견에 영향을 받지 않고, 나 자신을 높이 평가하는 편인가요?</div>
                    <div class="options-area-wrapper">
                        <div class="options-item" data-value="0"><img src="Image/기본버튼0.svg" alt="옵션 0 버튼"></div>
                        <div class="options-item" data-value="1"><img src="Image/기본버튼1.svg" alt="옵션 1 버튼"></div>
                        <div class="options-item" data-value="2"><img src="Image/기본버튼2.svg" alt="옵션 2 버튼"></div>
                        <div class="options-item" data-value="3"><img src="Image/기본버튼3.svg" alt="옵션 3 버튼"></div>
                    </div>
                    <div class="options-description">
                        <span>전혀 아니다</span>
                        <span>매우 그렇다</span>
                    </div>
                </div>
                
                <div class="submit-button-container">
                    <button class="submit-button">결과 보기</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // =========================================================================
            // 1. 변수 및 상태 관리 (Page 4 전용)
            // =========================================================================
            const currentPageId = 'page4';
            const nextPageUrl = 'test_Result.html'; // 결과 페이지 URL (이 URL로 이동합니다.)
            const prevPageUrl = 'test_page3.html';
            const totalPages = 4;
            const historyStateKey = 'quizHistory'; 
            const sessionHistoryKey = 'currentHistoryIndex';

            // Local Storage에서 전체 답변 상태를 가져오기 (없으면 초기화)
            // Local Storage를 사용하여 페이지 이동 간에 데이터를 유지합니다.
            let quizAnswers = JSON.parse(localStorage.getItem('quizAnswers')) || {};
            let answers = quizAnswers[currentPageId] || {}; 

            // 질문 ID와 항목 색상 매핑 (Q25~Q32)
            const colorMap = {
                'Q25': '노란', 'Q29': '노란', 
                'Q26': '보라', 'Q30': '보라', 
                'Q27': '핑크', 'Q31': '핑크', 
                'Q28': '초록', 'Q32': '초록', 
            };

            const options = document.querySelectorAll('.options-item');
            const submitButton = document.querySelector('.submit-button');
            const pageIndicator = document.querySelector('.page-indicator');
            pageIndicator.textContent = `${currentPageId.replace('page', '')} / ${totalPages}`;


            // =========================================================================
            // 2. 함수: UI 초기화 (버튼 상태 복원/업데이트)
            // =========================================================================
            function initializeUI() {
                options.forEach(item => {
                    const questionBlock = item.closest('.survey-question-block');
                    const questionId = questionBlock.dataset.questionId;
                    const itemValue = item.dataset.value;
                    const selectedImg = item.querySelector('img');

                    if (answers[questionId] && answers[questionId].value === itemValue) {
                        // 선택된 상태 복원
                        const color = colorMap[questionId];
                        selectedImg.src = `Image/${color}버튼${itemValue}.svg`;
                        item.classList.add('selected');
                    } else {
                        // 기본 상태
                        selectedImg.src = `Image/기본버튼${itemValue}.svg`;
                        item.classList.remove('selected');
                    }
                });
                checkAllAnswered();
            }

            // =========================================================================
            // 3. 함수: 모든 질문 응답 확인
            // =========================================================================
            function checkAllAnswered() {
                const requiredQuestions = document.querySelectorAll('.survey-question-block');
                let allAnswered = true;
                requiredQuestions.forEach(block => {
                    const questionId = block.dataset.questionId;
                    if (!answers[questionId] || answers[questionId].value === undefined) {
                        allAnswered = false;
                    }
                });

                if (allAnswered) {
                    submitButton.style.backgroundColor = 'var(--main-text-color)';
                    submitButton.disabled = false;
                } else {
                    submitButton.style.backgroundColor = '#ced4da';
                    submitButton.disabled = true;
                }
                return allAnswered;
            }

            // =========================================================================
            // 4. 이벤트 핸들러: 옵션 버튼 클릭 시 (선택 상태 저장)
            // =========================================================================
            options.forEach(item => {
                item.addEventListener('click', (event) => {
                    const selectedItem = event.currentTarget;
                    const questionBlock = selectedItem.closest('.survey-question-block');
                    const questionId = questionBlock.dataset.questionId;
                    const selectedValue = selectedItem.dataset.value; 

                    // 1. 기존 선택 해제 및 UI 업데이트
                    const siblings = questionBlock.querySelectorAll('.options-item');
                    siblings.forEach(sibling => {
                        sibling.classList.remove('selected');
                        const siblingValue = sibling.dataset.value;
                        sibling.querySelector('img').src = `Image/기본버튼${siblingValue}.svg`;
                    });

                    // 2. 새 선택 적용 및 UI 업데이트 (점수값에 맞는 색상 이미지 적용)
                    const color = colorMap[questionId];
                    selectedItem.classList.add('selected');
                    selectedItem.querySelector('img').src = `Image/${color}버튼${selectedValue}.svg`;


                    // 3. 답변 저장 
                    answers[questionId] = {
                        value: selectedValue 
                    };

                    // 4. Local Storage 업데이트
                    quizAnswers[currentPageId] = answers;
                    localStorage.setItem('quizAnswers', JSON.stringify(quizAnswers));

                    // 5. 다음 버튼 상태 확인
                    checkAllAnswered();
                });
            });


            // =========================================================================
            // 5. 이벤트 핸들러: 뒤로가기 버튼
            // =========================================================================
            const navIcon = document.querySelector('.nav-icon');
            navIcon.addEventListener('click', () => {
                const savedIndex = sessionStorage.getItem(sessionHistoryKey);
                if (savedIndex && parseInt(savedIndex) > 1) {
                    // History를 통해 뒤로가기
                    history.go(-1);
                } else {
                    // 이전 페이지로 직접 이동 (fallback)
                    window.location.href = prevPageUrl;
                }
            });


            // =========================================================================
            // 6. 이벤트 핸들러: 결과 보기 버튼 (요청하신 대로 수정됨)
            // =========================================================================
            submitButton.addEventListener('click', () => {
                if (!checkAllAnswered()) {
                    alert("모든 문항에 응답해주세요."); 
                    return;
                }
                
                // 1. 결과 데이터를 다음 페이지로 전달 (sessionStorage 사용)
                // quizAnswers 객체(page1~page4의 모든 응답 포함)를 'finalResultData' 키에 저장합니다.
                sessionStorage.setItem('finalResultData', JSON.stringify(quizAnswers));

                // 2. test_page1 ~ 4에 눌러놓은 데이터를 모두 초기화
                // Local Storage의 모든 응답 데이터를 삭제하여 초기화합니다.
                localStorage.removeItem('quizAnswers'); 

                // History 상태에 현재 페이지 인덱스를 저장 (기존 로직 유지)
                let currentHistoryIndex = 4; // page4의 인덱스는 4
                // history.pushState({ index: currentHistoryIndex }, '', nextPageUrl); // 결과 페이지로 이동하므로 주석 처리하거나 제거 가능

                // 결과 페이지로 이동
                window.location.href = nextPageUrl;
            });
            
            
            // =========================================================================
            // ⭐⭐⭐ BFCache 비활성화 코드 시작 ⭐⭐⭐
            // =========================================================================
            window.addEventListener('unload', function() {
                // 이 이벤트 리스너의 존재만으로 BFCache 저장이 방지되어,
                // 뒤로가기 시 페이지가 항상 새로 로드됩니다.
            });
            // ⭐⭐⭐ BFCache 비활성화 코드 끝 ⭐⭐⭐
            
            // =========================================================================
            // 7. 페이지 로드 시 상태 유지 (뒤로가기/앞으로가기 상태 복원)
            // =========================================================================
            window.addEventListener('pageshow', (event) => {
                // event.persisted가 true이면 BFCache에서 복원된 것 (이 로직은 이제 거의 실행되지 않음)
                if (event.persisted) {
                    const savedIndex = history.state.index; 
                    
                    // BFCache 로드 시 무조건 상태를 유지해야 함.
                    console.log('BFCache 로드 감지 (거의 비활성화). 현재 페이지 상태 유지.');
                    initializeUI();

                    // 다음 History 이동을 위해 현재 인덱스를 session storage에 반영
                    sessionStorage.setItem(sessionHistoryKey, savedIndex);
                } else if (history.state && history.state.index !== undefined) {
                    // 일반적인 페이지 로드 시에도 현재 인덱스를 session storage에 반영
                    sessionStorage.setItem(sessionHistoryKey, history.state.index);
                }
            });
            // =========================================================================
            
            // 페이지 로드 시 UI 상태 복원
            initializeUI();
        });
    </script>
</body>
</html>