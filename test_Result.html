<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>결과 페이지 - 막대 그래프 오버레이 (스크롤 가능)</title>
    <style>
        /* ------------------------------------------- */
        /* 0. 폰트 선언 */
        /* ------------------------------------------- */
        @font-face {
            font-family: 'SUIT';
            font-weight: 700; /* Bold weight */
            src: url('Font/SUIT-Bold.ttf') format('truetype'); 
            font-display: swap;
        }

        /* ------------------------------------------- */
        /* 1. 기본 설정 및 뷰포트 고정 (세로 스크롤 허용) */
        /* ------------------------------------------- */
        html, body {
            margin: 0;
            padding: 0;
            /* ⭐ 높이 제한 제거 */
            height: auto; 
            font-family: sans-serif;
            display: flex;
            /* 컨테이너 가로 중앙 정렬 */
            justify-content: center; 
            /* 컨테이너 세로 상단 정렬 (스크롤 시작점) */
            align-items: flex-start; 
            box-sizing: border-box;
            background-color: #ffffff; 
            /* ⭐ 가로 스크롤만 막고, 세로 스크롤은 body에서 자동 처리되도록 둡니다. */
            overflow-x: hidden; 
            overflow-y: auto; 
        }

        /* ------------------------------------------- */
        /* 2. 메인 컨테이너 (모바일 뷰포트 역할) (375px 고정 및 세로 스크롤) */
        /* ------------------------------------------- */
        #result-container {
            /* ⭐ 375px로 고정 */
            width: 375px; 
            max-width: 375px; 
            /* ⭐ 내용 길이에 따라 높이 자동 설정 */
            height: auto; 
            position: relative; 
            background-color: #ffffff; 
            /* ⭐ 컨테이너 내에서만 세로 스크롤 허용 (body에서 이미 처리하지만 명시적으로 유지) */
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch;
            /* ⭐ 하단 버튼 높이만큼 padding-bottom 다시 추가 */
            padding-bottom: 70px; 
        }
        
        /* 스크롤바 숨김 설정은 유지 */
        #result-container::-webkit-scrollbar { display: none; }
        #result-container { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* ------------------------------------------- */
        /* 3. 결과 이미지 및 배경 (원본 비율 복원) */
        /* ------------------------------------------- */
        .result-image {
            width: 100%;
            /* ⭐ 높이 강제 조정 제거, 원본 비율 사용 */
            height: auto; 
            /* ⭐ object-fit 제거 */
            object-fit: initial; 
            display: block;
            margin-top: 0; 
        }

        /* ------------------------------------------- */
        /* 4. 통계 섹션 (막대 그래프 영역) - 927px 유지 */
        /* ------------------------------------------- */
        .stat-section {
            position: absolute;
            top: 927px; /* 요청에 따라 927px 유지 */
            left: 80%; 
            transform: translateX(-50%);
            width: 90%; 
            max-width: 337.5px; 
            padding-top: 50px; 
            z-index: 5; 
        }
        
        .stat-item {
            display: flex;
            align-items: center;
        }
        
        .stat-item.item-1 { margin-bottom: 65px; } 
        .stat-item.item-2 { margin-bottom: 65px; } 
        .stat-item.item-3 { margin-bottom: 65px; } 
        .stat-item.item-4 { margin-bottom: 0px; }
 
        
        .bar-container {
            width: 176px; 
            height: 5px; 
            background-color: #e9ecef;
            border-radius: 2.5px; 
            overflow: hidden;
            margin: 0 10px 0 0; 
            flex-shrink: 0; 
        }

        .result-bar {
            height: 100%;
            transition: width 1s ease-out;
            border-radius: 2.5px; 
        }

        .yellow-bar { background-color: #EFF91D; }
        .purple-bar { background-color: #735BFF; }
        .pink-bar { background-color: #FC1DA4; }
        .green-bar { background-color: #64EF29; }
        .gray-bar { background-color: #ced4da; }

        .score-info {
            font-family: 'SUIT', sans-serif; 
            font-size: 24px; 
            font-weight: 700; 
            letter-spacing: -2px; 
            color: #161317; 
            width: 40px; 
            text-align: right;
            flex-shrink: 0;
            margin-bottom: 4px;
        }
        
        .score-info.gray-text {
            color: #adb5bd; 
        }
        
        /* ------------------------------------------- */
        /* 5. 기타 요소 오버레이 */
        /* ------------------------------------------- */
        .overlay-text-1 { 
            position: absolute; 
            top: 110px; 
            left: 50%; 
            transform: translateX(-50%); 
            font-size: 24px; 
            font-weight: 800; 
            color: #161317; 
            z-index: 5; 
        }
        
        /* ------------------------------------------- */
        /* 6. 하단 버튼 (Fixed Footer) - 유지 */
        /* ------------------------------------------- */
        .footer {
            width: 100%;
            /* ⭐ 컨테이너 너비와 동일하게 고정 */
            max-width: 375px; 
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            padding: 0; 
            background-color: #FFFFFF;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
            z-index: 100;
            display: flex; 
            justify-content: center; 
            align-items: center;
            height: 70px; 
        }

        .button-group {
            display: flex;
            gap: 7px; 
            width: 100%;
            max-width: 337.5px; 
            justify-content: space-between; 
        }

        .action-button {
            width: 169px; 
            height: 56px; 
            border: none;
            border-radius: 2px; 
            font-size: 16px;
            font-weight: 800;
            cursor: pointer;
            line-height: 56px; 
            text-align: center;
            display: inline-block;
            text-decoration: none;
            flex-shrink: 0; 
        }

        .test-again-button {
            background-color: #161317; 
            color: #FFFFFF; 
        }

        .view-product-button {
            background-color: #161317; 
            color: #FFFFFF; 
            border: 1px solid #161317; 
        }
    </style>
</head>
<body>
    <div id="result-container">
        <img id="result-main-image" src="Image/결과1_디지털.svg" alt="디지털 과부하 결과 이미지" class="result-image">

        <div class="stat-section">
            <div class="stat-item item-1">
                <div class="bar-container">
                    <div class="bar yellow-bar result-bar bar-1" style="width: 0%;"></div>
                </div>
                <span class="score-info percentage-text text-1">0%</span>
            </div>
            <div class="stat-item item-2">
                <div class="bar-container">
                    <div class="bar purple-bar result-bar bar-2" style="width: 0%;"></div>
                </div>
                <span class="score-info percentage-text text-2">0%</span>
            </div>
            <div class="stat-item item-3">
                <div class="bar-container">
                    <div class="bar pink-bar result-bar bar-3" style="width: 0%;"></div>
                </div>
                <span class="score-info percentage-text text-3">0%</span>
            </div>
            <div class="stat-item item-4">
                <div class="bar-container">
                    <div class="bar green-bar result-bar bar-4" style="width: 0%;"></div>
                </div>
                <span class="score-info percentage-text text-4">0%</span>
            </div>
        </div>
        
    </div>

    <div class="footer">
        <div class="button-group">
            <a href="index.html" class="action-button test-again-button">테스트 다시하기</a>
            <a href="result.html" class="action-button view-product-button">제품 구경하기</a>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // =========================================================================
            // 1. 점수 계산 로직 
            // =========================================================================

            const quizAnswers = JSON.parse(sessionStorage.getItem('finalResultData') || '{}');
            
            if (sessionStorage.getItem('finalResultData')) {
                sessionStorage.removeItem('finalResultData');
            }
            
            const maxScoreTotal = 24; 
            
            const questionMap = {
                'Q1': 'Yellow', 'Q5': 'Yellow', 'Q2': 'Purple', 'Q6': 'Pink', 'Q3': 'Pink', 'Q7': 'Purple', 'Q4': 'Green', 'Q8': 'Green',
                'Q9': 'Yellow', 'Q13': 'Yellow', 'Q10': 'Purple', 'Q15': 'Purple', 'Q11': 'Pink', 'Q14': 'Pink', 'Q12': 'Green', 'Q16': 'Green',
                'Q17': 'Yellow', 'Q21': 'Yellow', 'Q19': 'Purple', 'Q23': 'Purple', 'Q18': 'Pink', 'Q22': 'Pink', 'Q20': 'Green', 'Q24': 'Green',
                'Q25': 'Yellow', 'Q29': 'Yellow', 'Q27': 'Purple', 'Q31': 'Purple', 'Q26': 'Pink', 'Q30': 'Pink', 'Q28': 'Green', 'Q32': 'Green', 
            };
            
            let yellowScore = 0, purpleScore = 0, pinkScore = 0, greenScore = 0;
            
            if (Object.keys(quizAnswers).length > 0) {
                for (const pageId in quizAnswers) {
                    const answers = quizAnswers[pageId];
                    for (const qId in answers) {
                        const score = parseInt(answers[qId].value, 10);
                        const category = questionMap[qId];

                        if (category === 'Yellow') yellowScore += score;
                        else if (category === 'Purple') purpleScore += score;
                        else if (category === 'Pink') pinkScore += score;
                        else if (category === 'Green') greenScore += score;
                    }
                }
            } else {
                console.warn("결과 데이터를 찾을 수 없습니다. (finalResultData is empty)");
            }


            const calculatePercentage = (score) => Math.round((score / maxScoreTotal) * 100);

            const percentage = {
                Yellow: calculatePercentage(yellowScore),
                Purple: calculatePercentage(purpleScore),
                Pink: calculatePercentage(pinkScore),
                Green: calculatePercentage(greenScore)
            };
            
            const maxPercentage = Math.max(percentage.Yellow, percentage.Purple, percentage.Pink, percentage.Green);


            // =========================================================================
            // 2. 결과 이미지 설정 함수
            // =========================================================================
            function displayResultImage(percentages, maxScore) {
                const resultImage = document.getElementById('result-main-image');
                if (!resultImage) return;

                const Y = percentages.Yellow;
                const P = percentages.Purple;
                const I = percentages.Pink; 
                const G = percentages.Green; 

                const maxScoreValue = Math.max(Y, P, I, G);

                let key = '';
                if (Y === maxScoreValue) key += 'Y';
                if (P === maxScoreValue) key += 'P';
                if (I === maxScoreValue) key += 'I'; 
                if (G === maxScoreValue) key += 'G';
                
                if (key) {
                    sessionStorage.setItem('finalResultKey', key); 
                    console.log("Final Result Key saved:", key);
                }

                const imageMap = {
                    'Y': '결과1_디지털.svg', 'P': '결과2_수면.svg', 'I': '결과3_가성.svg', 'G': '결과4_알콜.svg', 
                    'YP': '결과5_디지털,수면.svg', 'YI': '결과6_디지털,가성.svg', 'YG': '결과7_디지털,알콜.svg', 
                    'PI': '결과8_수면,가성.svg', 'PG': '결과9_수면,알콜.svg', 'IG': '결과10_가성,알콜.svg', 
                    'YPI': '결과11_디지털,수면,가성.svg', 'YPG': '결과12_디지털,수면,알콜.svg', 
                    'YIG': '결과13_디지털,가성,알콜.svg', 'PIG': '결과14_수면,가성,알콜.svg', 
                    'YPIG': '결과15_디지털,수면,가성,알콜.svg', 
                };

                const fileName = imageMap[key];
                
                if (fileName) {
                    resultImage.src = `Image/${fileName}`;
                    resultImage.alt = `${key} 결과 이미지`; 
                } else {
                    resultImage.src = `Image/${imageMap['Y']}`;
                    resultImage.alt = '기본 디지털 과부하 결과 이미지';
                }
            }

            displayResultImage(percentage, maxPercentage);

            
            // =========================================================================
            // 3. UI 업데이트 함수 실행
            // =========================================================================

            const categoryInfo = [
                { key: 'Yellow', barSelector: '.result-bar.bar-1', colorClass: 'yellow-bar' },
                { key: 'Purple', barSelector: '.result-bar.bar-2', colorClass: 'purple-bar' },
                { key: 'Pink', barSelector: '.result-bar.bar-3', colorClass: 'pink-bar' },
                { key: 'Green', barSelector: '.result-bar.bar-4', colorClass: 'green-bar' }
            ];
            
            const GRAY_CLASS = 'gray-bar';
            const ALL_COLOR_CLASSES = categoryInfo.map(c => c.colorClass).join(' ') + ' ' + GRAY_CLASS;

            categoryInfo.forEach((info, index) => {
                const percent = percentage[info.key];
                const isWinner = percent === maxPercentage;

                const barElement = document.querySelector(info.barSelector);
                const textElement = document.querySelector(`.percentage-text.text-${index + 1}`);

                if (barElement) {
                    barElement.classList.remove(...ALL_COLOR_CLASSES.split(' ')); 

                    if (isWinner) {
                        barElement.classList.add(info.colorClass);
                    } else {
                        barElement.classList.add(GRAY_CLASS);
                    }
                    
                    barElement.style.width = `${percent}%`;
                }

                if (textElement) {
                    textElement.textContent = `${percent}%`;
                    
                    if (isWinner) {
                        textElement.classList.remove('gray-text'); 
                    } else {
                        textElement.classList.add('gray-text'); 
                    }
                }
            });

        });
    </script>
</body>
</html>